import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from scipy import stats
from scipy.interpolate import interp1d

# Configuraci√≥n de la p√°gina con identidad visual de la UVigo
st.set_page_config(page_title="Analizador de Tracci√≥n - EEAE UVigo", layout="wide")

st.title("üöÄ Analizador de Ensayos de Tracci√≥n - Materiales Aeroespaciales")
st.subheader("Escola de Enxe√±ar√≠a Aeron√°utica e do Espazo | Universidade de Vigo")

# --- SIDEBAR: DATOS DE LA PROBETA (SEG√öN FICHA CTM) ---
with st.sidebar:
    st.header("Configuraci√≥n de la Probeta")
    tipo_probeta = st.selectbox("Geometr√≠a de la probeta", ["Cil√≠ndrica", "Plana"])

    if tipo_probeta == "Cil√≠ndrica":
        d0 = st.number_input("Di√°metro inicial d‚ÇÄ (mm)", value=10.0)
        s0 = np.pi * (d0**2) / 4
    else:
        ancho = st.number_input("Ancho b (mm)", value=10.0)
        espesor = st.number_input("Espesor t (mm)", value=2.0)
        s0 = ancho * espesor

    l0 = st.number_input("Longitud inicial L‚ÇÄ (mm)", value=50.0)
    lu = st.number_input("Longitud final tras rotura L·µ§ (mm)", value=55.0)
    su = st.number_input("Secci√≥n final tras rotura S·µ§ (mm¬≤)", value=s0*0.8)
    material = st.text_input("Identificaci√≥n del Material", "Aluminio 7075-T6")

    st.divider()
    st.info(f"**Secci√≥n Inicial S‚ÇÄ:** {s0:.2f} mm¬≤")

# --- CARGA Y PROCESAMIENTO ROBUSTO DEL CSV ---
st.write("### 1. Carga de Datos del Ensayo")
uploaded_file = st.file_uploader("Sube el archivo CSV (Formato m√°quina UVigo)", type=["csv"])

if uploaded_file:
    try:
        # Leemos saltando la primera fila de metadatos. Decimales con coma.
        df = pd.read_csv(uploaded_file, header=1, decimal=',', skipinitialspace=True)
        
        # RENOMBRADO POR POSICI√ìN: Evita el KeyError: 'Fuerza'
        # Fuerza es la columna 1, Desplazamiento es la 2.
        df.columns = ['Tiempo', 'Fuerza', 'Desplazamiento']
        
        # Eliminamos la fila de unidades (seg, N, mm)
        df = df.iloc[1:].reset_index(drop=True)
        
        # Convertimos todo a num√©rico
        df = df.apply(pd.to_numeric, errors='coerce').dropna()
        
        st.success("‚úÖ Datos cargados correctamente. Columnas identificadas por posici√≥n.")
        
    except Exception as e:
        st.error(f"Error al procesar el archivo: {e}")
        st.stop()

    # --- C√ÅLCULOS T√âCNICOS (FICHA CTM) ---
    # Tensi√≥n (œÉ) = Fuerza / S0
    df['Tension_MPa'] = df['Fuerza'] / s0
    # Deformaci√≥n (Œµ) = ŒîL / L0
    df['Deformacion_unit'] = df['Desplazamiento'] / l0
    
    # 1. Resistencia a la tracci√≥n (Rm)
    rm = df['Tension_MPa'].max()
    idx_max = df['Tension_MPa'].idxmax()
    agt = df.loc[idx_max, 'Deformacion_unit'] * 100 # % bajo carga m√°xima
    
    # 2. M√≥dulo de Young (E) - Regresi√≥n en la zona inicial
    zona_elastica = df.iloc[:int(len(df)*0.08)] 
    slope, _, _, _, _ = stats.linregress(zona_elastica['Deformacion_unit'], zona_elastica['Tension_MPa'])
    e_young = slope # MPa
    
    # 3. L√≠mite El√°stico Rp0.2 (Paralela al 0.2%)
    offset = 0.002
    try:
        linea_offset = e_young * (df['Deformacion_unit'] - offset)
        idx_p02 = np.argwhere(np.diff(np.sign(df['Tension_MPa'] - linea_offset))).flatten()[0]
        rp02 = df.loc[idx_p02, 'Tension_MPa']
        eps_p02 = df.loc[idx_p02, 'Deformacion_unit']
    except:
        rp02 = rm * 0.85 # Estimaci√≥n si falla la intersecci√≥n
        eps_p02 = (rp02/e_young) + offset

    # 4. Alargamiento a rotura (A %) y Estricci√≥n (Z %)
    a_porc = ((lu - l0) / l0) * 100
    z_porc = ((s0 - su) / s0) * 100

    # --- VISUALIZACI√ìN ---
    col1, col2 = st.columns([2, 1])

    with col1:
        st.subheader("Gr√°fica: Diagrama Tensi√≥n-Deformaci√≥n")
        fig, ax = plt.subplots(figsize=(10, 6))
        ax.plot(df['Deformacion_unit'], df['Tension_MPa'], label='Curva de Ensayo', color='#004b87', lw=2)
        
        # Dibujar Rp0.2
        ax.plot(df['Deformacion_unit'], e_young*(df['Deformacion_unit']-0.002), '--', color='gray', alpha=0.5, label='L√≠nea Offset 0.2%')
        ax.scatter(eps_p02, rp02, color='red', s=50, zorder=5, label=f'Rp0.2: {rp02:.1f} MPa')
        
        # Dibujar Rm
        ax.scatter(df.loc[idx_max, 'Deformacion_unit'], rm, color='green', s=50, zorder=5, label=f'Rm: {rm:.1f} MPa')
        
        ax.set_xlabel("Deformaci√≥n Unitaria Œµ (mm/mm)")
        ax.set_ylabel("Tensi√≥n œÉ (MPa)")
        ax.set_ylim(0, rm * 1.15)
        ax.set_xlim(0, df['Deformacion_unit'].max() * 1.05)
        ax.legend()
        ax.grid(True, linestyle=':', alpha=0.6)
        st.pyplot(fig)

    with col2:
        st.subheader("Informe de Resultados")
        res_df = pd.DataFrame({
            "Propiedad Mec√°nica": ["M√≥dulo de Young (E)", "L√≠mite El√°stico (Rp0.2)", "Resistencia M√°xima (Rm)", "Alargamiento (A)", "Estricci√≥n (Z)"],
            "Unidad": ["GPa", "MPa", "MPa", "%", "%"],
            "Resultado": [f"{e_young/1000:.1f}", f"{rp02:.1f}", f"{rm:.1f}", f"{a_porc:.1f}", f"{z_porc:.1f}"]
        })
        st.table(res_df)
        
        st.download_button("Descargar Datos Procesados (CSV)", df.to_csv(index=False), "resultados_ensayo.csv", "text/csv")

else:
    st.info("üëã Sube el archivo de la m√°quina de ensayos para generar el an√°lisis autom√°tico.")

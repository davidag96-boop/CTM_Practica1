import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from scipy import stats

# Configuraci√≥n profesional de la p√°gina
st.set_page_config(page_title="Analizador Materiales - UVigo", layout="wide")

st.title("üõ°Ô∏è Analizador Universal de Ensayos de Tracci√≥n")
st.write("### Escuela de Ingenier√≠a Aeroespacial | Universidade de Vigo")

# --- SIDEBAR: PAR√ÅMETROS T√âCNICOS ---
with st.sidebar:
    st.header("Configuraci√≥n de Probeta")
    material = st.text_input("Material", value="Aluminio 7075-T6")
    tipo = st.selectbox("Geometr√≠a", ["Cil√≠ndrica", "Plana"])
    
    if tipo == "Cil√≠ndrica":
        d0 = st.number_input("Di√°metro inicial d‚ÇÄ (mm)", value=10.0)
        s0 = np.pi * (d0**2) / 4
    else:
        ancho = st.number_input("Ancho b (mm)", value=10.0)
        espesor = st.number_input("Espesor t (mm)", value=2.0)
        s0 = ancho * espesor
        
    l0 = st.number_input("Longitud inicial L‚ÇÄ (mm)", value=50.0)
    lu = st.number_input("Longitud final L·µ§ (mm)", value=55.4)
    st.info(f"Secci√≥n Calculada S‚ÇÄ: {s0:.2f} mm¬≤")

# --- CARGA Y LIMPIEZA AGRESIVA DE DATOS ---
uploaded_file = st.file_uploader("Sube tu archivo CSV del laboratorio", type="csv")

if uploaded_file:
    try:
        # 1. Leemos el archivo completo como texto para limpiar caracteres extra√±os
        raw_data = uploaded_file.getvalue().decode("utf-8").splitlines()
        
        # 2. Buscamos la primera l√≠nea que realmente contenga datos num√©ricos
        data_rows = []
        for line in raw_data:
            # Limpiamos comillas y espacios, y cambiamos coma decimal por punto
            clean_line = line.replace('"', '').replace(',', '.')
            parts = clean_line.split('.') # Intentamos ver si hay puntos decimales
            # Si la l√≠nea tiene al menos un n√∫mero tras limpiar, la guardamos
            if any(c.isdigit() for c in clean_line):
                # Intentamos separar por comas (formato CSV)
                row = [p.strip() for p in clean_line.split(',')]
                # Solo guardamos si tiene al menos 3 columnas (Tiempo, Fuerza, Despl)
                if len(row) >= 3:
                    try:
                        # Comprobamos si el primer elemento es un n√∫mero
                        float(row[0])
                        data_rows.append([float(r) for r in row[:3]])
                    except:
                        continue
        
        # 3. Creamos el DataFrame final por posici√≥n
        df = pd.DataFrame(data_rows, columns=['Tiempo', 'Fuerza', 'Desplazamiento'])
        
        if df.empty:
            st.error("No se detectaron datos v√°lidos. Comprueba que el CSV tiene 3 columnas num√©ricas.")
            st.stop()
            
        st.success(f"‚úÖ Se han procesado {len(df)} puntos de datos correctamente.")

        # --- C√ÅLCULOS DE INGENIER√çA ---
        df['Tension_MPa'] = df['Fuerza'] / s0
        df['Deformacion_unit'] = df['Desplazamiento'] / l0
        
        # Rm (Resistencia m√°xima)
        rm = df['Tension_MPa'].max()
        idx_max = df['Tension_MPa'].idxmax()
        
        # M√≥dulo de Young (E) - Tomamos el primer 10% de la curva
        limit = int(len(df) * 0.1)
        slope, intercept, r_val, p_val, std_err = stats.linregress(
            df['Deformacion_unit'].iloc[:limit], 
            df['Tension_MPa'].iloc[:limit]
        )
        e_young_gpa = slope / 1000 # Convertir MPa a GPa

        # --- REPRESENTACI√ìN GR√ÅFICA ---
        st.subheader("Curva Tensi√≥n-Deformaci√≥n (Ingenier√≠a)")
        
        fig, ax = plt.subplots(figsize=(10, 5))
        ax.plot(df['Deformacion_unit'], df['Tension_MPa'], label='Ensayo Real', color='#004b87', lw=2)
        
        # Punto Rm
        ax.scatter(df['Deformacion_unit'].iloc[idx_max], rm, color='red', zorder=5)
        ax.annotate(f'Rm: {rm:.1f} MPa', 
                    (df['Deformacion_unit'].iloc[idx_max], rm), 
                    textcoords="offset points", xytext=(0,10), ha='center')
        
        ax.set_xlabel("Deformaci√≥n Unitaria Œµ (mm/mm)")
        ax.set_ylabel("Tensi√≥n œÉ (MPa)")
        ax.grid(True, linestyle=':', alpha=0.6)
        ax.legend()
        st.pyplot(fig)

        # --- TABLA DE RESULTADOS ---
        st.subheader("Resultados del Informe")
        a_porc = ((lu - l0) / l0) * 100
        
        res_col1, res_col2, res_col3 = st.columns(3)
        res_col1.metric("M√≥dulo de Young (E)", f"{e_young_gpa:.1f} GPa")
        res_col2.metric("Resistencia M√°xima (Rm)", f"{rm:.1f} MPa")
        res_col3.metric("Alargamiento (A)", f"{a_porc:.1f} %")

    except Exception as e:
        st.error(f"Fallo cr√≠tico en el procesamiento: {e}")

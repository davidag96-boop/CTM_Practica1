import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from scipy import stats
from scipy.interpolate import interp1d

# Configuraci√≥n de la p√°gina
st.set_page_config(page_title="Analizador EEAE UVigo", layout="wide")

st.title("üöÄ Analizador de Ensayos de Tracci√≥n - EEAE")
st.write("Configurado para el formato de salida de la m√°quina de ensayos (PLA_1H3.csv)")

# --- BARRA LATERAL: ENTRADA DE DATOS DE LA FICHA CTM ---
st.write("### 1. Carga de Datos del Ensayo")

# A√±adimos una opci√≥n para usar datos de ejemplo directamente
usar_ejemplo = st.checkbox("Usar datos de ejemplo (Aluminio 7075-T6)")

if usar_ejemplo:
    # Estos son los datos resumidos para que el c√≥digo no sea infinito
    # En una situaci√≥n real, aqu√≠ cargar√≠as el archivo 'ensayo_7075.csv'
    uploaded_file = "ensayo_7075_pro.csv" 
    st.info("Cargando datos preconfigurados de Aluminio Aeroespacial...")
else:
    uploaded_file = st.file_uploader("Sube el archivo CSV del ensayo", type="csv")

if uploaded_file:
    try:
        # Si es el ejemplo, lo leemos de la carpeta; si no, del uploader
        df = pd.read_csv(uploaded_file, header=1, decimal=',')
        df = df.iloc[1:].reset_index(drop=True)
        df = df.apply(pd.to_numeric, errors='coerce').dropna()
with st.sidebar:
    st.header("Datos de la Probeta")
    st.write("Introduce los datos medidos en el laboratorio:")
    tipo_geo = st.selectbox("Geometr√≠a", ["Cil√≠ndrica", "Plana"])
    
    if tipo_geo == "Cil√≠ndrica":
        d0 = st.number_input("Di√°metro inicial d‚ÇÄ (mm)", value=10.0)
        s0 = np.pi * (d0**2) / 4
    else:
        ancho = st.number_input("Ancho b (mm)", value=10.0)
        espesor = st.number_input("Espesor t (mm)", value=2.0)
        s0 = ancho * espesor
        
    l0 = st.number_input("Longitud inicial L‚ÇÄ (mm)", value=50.0)
    lu = st.number_input("Longitud final L·µ§ (mm)", value=55.0)
    su = st.number_input("Secci√≥n final en la rotura S·µ§ (mm¬≤)", value=s0*0.8)

# --- PROCESAMIENTO DEL ARCHIVO CSV ---
uploaded_file = st.file_uploader("Sube el archivo CSV del ensayo", type="csv")

if uploaded_file:
    # Ajuste para el formato espec√≠fico: salta la fila 1 y 3, maneja decimales con coma
    try:
        # Leemos desde la fila de encabezados (fila 1, √≠ndice 1)
        df = pd.read_csv(uploaded_file, header=1, decimal=',')
        # Eliminamos la fila de unidades (que qued√≥ como la primera fila de datos)
        df = df.iloc[1:].reset_index(drop=True)
        # Convertimos a num√©rico por si acaso
        df = df.apply(pd.to_numeric, errors='coerce').dropna()
        
        st.success("Archivo procesado con √©xito siguiendo el formato de la m√°quina.")
    except Exception as e:
        st.error(f"Error al leer el archivo: {e}")
        st.stop()

    # C√°lculos seg√∫n Ficha de Tracci√≥n CTM [cite: 43, 87]
    df['Tension_MPa'] = df['Fuerza'] / s0
    df['Deformacion_unit'] = df['Desplazamiento'] / l0
    
    # 1. Resistencia a la tracci√≥n (Rm) [cite: 89]
    rm = df['Tension_MPa'].max()
    idx_max = df['Tension_MPa'].idxmax()
    agt = df.loc[idx_max, 'Deformacion_unit'] * 100 # Agt % [cite: 113]
    
    # 2. M√≥dulo de Young (E) [cite: 82]
    # Usamos una regresi√≥n en la zona inicial (primera parte de la curva)
    zona_elastica = df.iloc[:int(len(df)*0.05)] 
    slope, _, _, _, _ = stats.linregress(zona_elastica['Deformacion_unit'], zona_elastica['Tension_MPa'])
    e_young = slope # En MPa
    
    # 3. Alargamiento a rotura (A %) [cite: 97]
    a_porc = ((lu - l0) / l0) * 100
    
    # 4. Estricci√≥n (Z %) [cite: 107]
    z_porc = ((s0 - su) / s0) * 100

    # --- REPRESENTACI√ìN GR√ÅFICA ---
    st.subheader("Curva de Tracci√≥n (Tensi√≥n vs Deformaci√≥n)")
    fig, ax = plt.subplots(figsize=(10, 5))
    ax.plot(df['Deformacion_unit'], df['Tension_MPa'], label='Ensayo Real', color='blue')
    ax.set_xlabel("Deformaci√≥n Unitaria (Œµ)")
    ax.set_ylabel("Tensi√≥n (MPa)")
    ax.set_title("Diagrama Tensi√≥n-Deformaci√≥n")
    ax.grid(True, linestyle='--', alpha=0.7)
    
    # Marcamos Rm en la gr√°fica
    ax.scatter(df.loc[idx_max, 'Deformacion_unit'], rm, color='red', zorder=5)
    ax.annotate(f'Rm: {rm:.1f} MPa', (df.loc[idx_max, 'Deformacion_unit'], rm), textcoords="offset points", xytext=(0,10), ha='center')
    
    st.pyplot(fig)

    # --- TABLA DE RESULTADOS (INFORME) ---
    st.subheader("Resultados del Informe de Ensayo")
    res_data = {
        "Par√°metro": ["Resistencia M√°xima (Rm)", "M√≥dulo de Elasticidad (E)", "Alargamiento a Rotura (A)", "Extensi√≥n bajo carga m√°x (Agt)", "Estricci√≥n (Z)"],
        "S√≠mbolo": ["MPa", "GPa", "%", "%", "%"],
        "Valor": [f"{rm:.2f}", f"{e_young/1000:.2f}", f"{a_porc:.2f}", f"{agt:.2f}", f"{z_porc:.2f}"]
    }
    st.table(pd.DataFrame(res_data))
